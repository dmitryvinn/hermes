<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Hermes Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Hermes Blog Atom Feed"><title data-react-helmet="true">Memory Profilers | Hermes</title><meta data-react-helmet="true" property="og:url" content="https://hermesengine.dev/docs/memory-profilers"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Memory Profilers | Hermes"><meta data-react-helmet="true" name="description" content="&lt;!--"><meta data-react-helmet="true" property="og:description" content="&lt;!--"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://hermesengine.dev/docs/memory-profilers"><link data-react-helmet="true" rel="alternate" href="https://hermesengine.dev/docs/memory-profilers" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://hermesengine.dev/docs/memory-profilers" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.e103a2e1.css">
<link rel="preload" href="/assets/js/runtime~main.aa2d953b.js" as="script">
<link rel="preload" href="/assets/js/main.fc6ba424.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Hermes Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Hermes Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Hermes</strong></a><a class="navbar__item navbar__link" href="/docs/building-and-running">Docs</a><a class="navbar__item navbar__link" href="/playground/">Playground</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/hermes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Hermes Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Hermes Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Hermes</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/building-and-running">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/playground/">Playground</a></li><li class="menu__list-item"><a href="https://github.com/facebook/hermes" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Documentation</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/building-and-running">Building and Running</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/emscripten">Building with Emscripten</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cross-compilation">Cross Compilation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/language-features">Language Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/intl">Internationalization APIs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/memory-profilers">Memory Profilers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design">Design Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ir">Design of the IR</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/optimizer">Design of the Optimizer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/vm">VM Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/gengc">The GenGC Garbage Collector</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hades">The Hades Garbage Collector</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/modules">Modules</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/strings">Strings</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/regexp">RegExp</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Integrations</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/react-native-integration">React Native Integration</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Contributing</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/coding-standards">Coding Standards</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Memory Profilers</h1></header><div class="markdown"><p>This page describes the various tools you can use to diagnose memory issues in
your app using Hermes. The tools can be used in a variety of ways based on
your needs.</p><p>The main goal of these profilers are to help you identify ways your app can
reduce its memory footprint. This is important for improving the user experience
in many ways:</p><ul><li>Your app can run faster and have fewer, less expensive garbage collection
cycles</li><li>Your app can avoid running out of memory entirely, and crashing with an Out of Memory (OOM) error</li><li>Your app can avoid being killed by the operating system for using too much memory</li></ul><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="heap-snapshots"></a>Heap Snapshots<a class="hash-link" href="#heap-snapshots" title="Direct link to heading">#</a></h1><p>A Heap Snapshot is a view of the entire JavaScript heap at a point in time. It
represents the data as a graph, where nodes are the values in the heap, and the
edges are pointers from one node to another. The snapshot can answer these types
of questions:</p><ul><li>What types of values is my app using?</li><li>How much memory do those values use?</li><li>What memory is being retained unnecessarily?</li></ul><p>The nodes in the snapshot can be any value usable in JS, such as:</p><ul><li>Objects: <code>{a: 1, b: 2}</code></li><li>Arrays: <code>[1, 2, 3]</code></li><li>Functions: <code>function foo(args) { ... }</code></li><li>Strings: <code>&quot;hello world&quot;</code></li><li>Numbers: <code>3.14</code></li><li>Native host memory, injected into the heap via <code>jsi::HostFunction</code> and
<code>jsi::HostObject</code> in the JSI API</li><li>Hermes-specific internal memory, such as <code>Environment</code>, <code>ArrayStorage</code>, and
<code>HiddenClass</code>, and the backing storage of ArrayBuffers.</li></ul><p>Each node has a list of edges to other nodes, which can be used to determine
what nodes <strong>retain</strong> other nodes. If node A retains node B, that means if A
is reachable by your program, B will also remain reachable. Therefore, B cannot
be garbage collected until A is garbage collected.
Many heap snapshot viewers will define the difference between <strong>shallow size</strong>
and <strong>retained size</strong>. <strong>Shallow size</strong> is the size of just that node, whereas
<strong>retained size</strong> is the size of all the nodes the current node retains.</p><p>The snapshot format is a JSON file ending in <code>.heapsnapshot</code>, and is the same
format used by the Chrome Developer Tools and the V8 JavaScript engine. This
means all tools that work with heap snapshots taken from V8, Chrome, or Node.js
are also compatible with snapshots taken from Hermes.</p><p>In particular, you can take memory snapshots from the Chrome Developer Tools
connected to Hermes!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="taking-a-heap-snapshot-with-the-chrome-devtools"></a>Taking a heap snapshot with the Chrome DevTools<a class="hash-link" href="#taking-a-heap-snapshot-with-the-chrome-devtools" title="Direct link to heading">#</a></h2><p>Before reading this section, make sure you can
<a href="https://reactnative.dev/docs/next/hermes#debugging-js-on-hermes-using-google-chromes-devtools" target="_blank" rel="noopener noreferrer">connect the Chrome DevTools to Hermes</a>
to debug some JavaScript. Once you have that set up you can proceed.</p><ol><li>Open the &quot;Memory&quot; tab of the DevTools, and make sure the &quot;Heap snapshot&quot; radio
button is selected</li><li>(Optional): Click on the garbage can icon in the top left to collect any
unreachable objects. This will prevent them from showing up in the snapshot.</li><li>Click on &quot;Take snapshot&quot;</li></ol><video muted="" loop="" controls="" height="auto" width="100%" alt="Take a heap snapshot from Chrome"><source src="https://assets.hermesengine.dev/chrome_take_heap_snapshot.mp4" type="video/mp4">Your browser does not support the video/mp4 encoding.</video><p>Chrome will alert Hermes that a snapshot is requested, and Hermes will stream
the snapshot JSON file back to Chrome. This may take some time if you have a
large heap. Once it&#x27;s completed, you can go to the
<a href="#Using-the-Chrome-Devtools-Heap-Snapshot-Explorer">Using the Chrome DevTools Heap Snapshot Explorer</a>
section to start reading it.</p><p>You can save the snapshot to disk by pressing the &quot;Save&quot; button on your snapshot
in the Chrome menu:</p><video muted="" loop="" controls="" height="auto" width="100%" alt="Save heap snapshot to disk from Chrome"><source src="https://assets.hermesengine.dev/chrome_save_heap_snapshot.mp4" type="video/mp4">Your browser does not support the video/mp4 encoding.</video><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="taking-a-heap-snapshot-from-c"></a>Taking a heap snapshot from C++<a class="hash-link" href="#taking-a-heap-snapshot-from-c" title="Direct link to heading">#</a></h2><p>Using the Chrome DevTools only applies when you have attached a debugger. For
various reasons, it might be hard to do that for your app. In those cases, you
can write some C++ code to ask Hermes for a heap snapshot.</p><p>Before reading this section, make sure to read the JSI documentation which
explains all of the basics of the API.</p><p>Now, say you have some Native Module in React Native, and you want to create
a heap snapshot. Here&#x27;s what you do:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#FFFFFF;background:#242526"><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token keyword" style="color:#c5a5c5">void</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">myFunc</span><span class="token punctuation" style="color:#657b83">(</span><span class="token plain">jsi</span><span class="token operator" style="color:#fc929e">::</span><span class="token plain">Runtime </span><span class="token operator" style="color:#fc929e">&amp;</span><span class="token plain">rt</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token plain"></span></div><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain">  </span><span class="token comment" style="color:#93a1a1">// If you want to write to a file name, use createSnapshotToFile.</span><span class="token plain"></span></div><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain">  rt</span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">instrumentation</span><span class="token punctuation" style="color:#657b83">(</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">createSnapshotToFile</span><span class="token punctuation" style="color:#657b83">(</span><span class="token string" style="color:#8dc891">&quot;/tmp/filename.heapsnapshot&quot;</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span></div><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain">  </span><span class="token comment" style="color:#93a1a1">// If you already have a C++ std::ostream set up, use createSnapshotToStream.</span><span class="token plain"></span></div><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain">  rt</span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">instrumentation</span><span class="token punctuation" style="color:#657b83">(</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">.</span><span class="token function" style="color:#79b6f2">createSnapshotToStream</span><span class="token punctuation" style="color:#657b83">(</span><span class="token plain">std</span><span class="token operator" style="color:#fc929e">::</span><span class="token plain">cout</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span></div><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain"></span><span class="token punctuation" style="color:#657b83">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>This method gives you a lot of flexibility of when and where you want to set up
your heap snapshots. You can also expose the functionality above through a
<code>jsi::HostFunction</code> and call it from JS. The downside is you&#x27;ll need to add a
new native module and build React Native from source for your app.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="taking-a-heap-snapshot-from-javascript-with-the-hermes-cli"></a>Taking a heap snapshot from JavaScript with the Hermes CLI<a class="hash-link" href="#taking-a-heap-snapshot-from-javascript-with-the-hermes-cli" title="Direct link to heading">#</a></h2><p>Currently, it isn&#x27;t possible to take a heap snapshot from JavaScript unless you
are running hermes via the command line interface.</p><p>If you are running from the command line interface, there&#x27;s a function defined
on the global object called <code>createHeapSnapshot</code>, used like so:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#FFFFFF;background:#242526"><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token comment" style="color:#93a1a1">// Calling with no arguments will print to stdout</span><span class="token plain"></span></div><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain"></span><span class="token function" style="color:#79b6f2">createHeapSnapshot</span><span class="token punctuation" style="color:#657b83">(</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span></div><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain"></span><span class="token comment" style="color:#93a1a1">// Calling with a single string argument will write the snapshot to that file</span><span class="token plain"></span></div><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain"></span><span class="token comment" style="color:#93a1a1">// path. If it isn&#x27;t a valid file, or the permissions won&#x27;t allow Hermes to</span><span class="token plain"></span></div><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain"></span><span class="token comment" style="color:#93a1a1">// write to it, it&#x27;ll throw a TypeError</span><span class="token plain"></span></div><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain"></span><span class="token function" style="color:#79b6f2">createHeapSnapshot</span><span class="token punctuation" style="color:#657b83">(</span><span class="token string" style="color:#8dc891">&quot;/tmp/filename.heapsnapshot&quot;</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Note that <code>createHeapSnapshot</code> does not exist if you are running Hermes in
React Native, and you will get an exception if you try to use it.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="loading-a-heap-snapshot-from-disk"></a>Loading a heap snapshot from disk<a class="hash-link" href="#loading-a-heap-snapshot-from-disk" title="Direct link to heading">#</a></h2><p>If after any of the above methods you have a <code>filename.heapsnapshot</code> file saved
somewhere, you can load that into Chrome without needing to connect to any
running app. From the &quot;Memory&quot; tab, next to &quot;Take snapshot&quot; there is a &quot;Load&quot;
button which will open a file browser. Navigate to the file you want to load
and open it.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="using-the-chrome-devtools-heap-snapshot-explorer"></a>Using the Chrome DevTools Heap Snapshot Explorer<a class="hash-link" href="#using-the-chrome-devtools-heap-snapshot-explorer" title="Direct link to heading">#</a></h2><p>Now you have a heap snapshot taken and you want to find a memory problem. Here&#x27;s
an explanation of what you can do in Chrome.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sorting"></a>Sorting<a class="hash-link" href="#sorting" title="Direct link to heading">#</a></h3><p>You can sort by any of the following categories by clicking on the category
name:</p><ul><li>Retained Size: size of all nodes pointed to by this node</li><li>Shallow Size: size of just the node itself</li><li>Constructor: The name of the constructor of the node. Can think of it as a
type name</li><li>Distance: The number of edges needed to traverse from a root to this node</li></ul><p>Click a second time to reverse the order of the sort.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="type-names"></a>Type names<a class="hash-link" href="#type-names" title="Direct link to heading">#</a></h3><p>You can search for a type name, which uses the name of the constructor function
by default. For example, if you have code like the following:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#FFFFFF;background:#242526"><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#79b6f2">MyObject</span><span class="token punctuation" style="color:#657b83">(</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token punctuation" style="color:#657b83">}</span><span class="token plain"></span></div><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">var</span><span class="token plain"> obj </span><span class="token operator" style="color:#fc929e">=</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">new</span><span class="token plain"> </span><span class="token class-name" style="color:#fac863">MyObject</span><span class="token punctuation" style="color:#657b83">(</span><span class="token punctuation" style="color:#657b83">)</span><span class="token punctuation" style="color:#657b83">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The node for <code>obj</code> in the snapshot will have the constructor name <code>MyObject</code>.
Expanding the type category will show all objects that are in the heap of that
type.</p><p>Hermes tries to be as specific as it can with type names for objects. For
objects created without a constructor, such as object literals
(<code>{a: 1, b: &quot;hello&quot;}</code>), Hermes will display its type name as <code>Object(a, b)</code>. If
an object has more than 5 properties, it will be displayed as
<code>Object(a, b, c, d, e, ...)</code>. If an object has more than
<code>HiddenClass::kDictionaryThreshold</code> properties (currently 64), it will be
displayed as <code>Object(Dictionary)</code>.
Warning: If you change the name of the constructor function dynamically, or if
the <code>.name</code> property of a function is an accessor, Hermes may only report the
original name of the function as defined in the source file.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="retainers"></a>Retainers<a class="hash-link" href="#retainers" title="Direct link to heading">#</a></h3><p>If you click on a particular object in your snapshot, a drawer will pop up below
saying &quot;Retainers&quot;. This drawer will show a tree of all nodes that have a
reference to this node.</p><p>If you click on the dropdown arrow for one node, you&#x27;ll see all of the other
nodes which retain that node, and so on until you reach what&#x27;s called a &quot;root&quot;
of the heap. You can also right-click on a node in the retainers drawer and
click on &quot;Reveal in Summary view&quot; to jump to that node in the summary box.</p><p><img alt="Retainers of a node" src="/assets/images/heap_snapshot_retainers-d4ae4ba02c9582f647defa261d27ab99.png"></p><p>In this example, you can see that an object (who has an &quot;a&quot; property), is
retained by the property &quot;x&quot; in an instance of MyObject. That object is retained
by the 1,000th element in an array. That array is retained by <code>(Registers)</code>,
which is the root category for all local variables on the JS stack.</p><p>Below you can see some more of the root categories that Hermes uses to describe
some things that can retain objects:</p><p><img alt="Hermes Root Categories" src="/assets/images/root_categories-97190f8885d8339e4a904d766002d38e.png"></p><p>The most important ones are:</p><ul><li><code>(Registers)</code>: all local variables on the JS stack</li><li><code>(IdentifierTable)</code>: a table of strings used as object properties and symbol
descriptions</li><li><code>(GCScopes)</code>: the equivalent of the <code>(Registers)</code> group for native code inside
the Hermes engine. These hold onto JS values currently in use by native code</li><li><code>(Prototypes)</code>: lists of prototypes and constructors of system objects like
<code>Function</code> and array iterators</li><li><code>(Custom)</code>: these are any roots created by native code outside of Hermes. In
the case of any embedder using JSI (such as React Native), this corresponds to
the <code>jsi::Value</code>s being used</li><li><code>(SymbolRegistry)</code>: this is a table of all symbols made by <code>Symbol.for(&quot;foo&quot;)</code></li></ul><p>Knowing which root anchors your node is an important step to knowing why it is
being retained, and if it shouldn&#x27;t be. If an object doesn&#x27;t have a retaining
path to the root, it means there is nothing keeping it alive, and it will be
collected at the next garbage collection cycle.</p><p>Outside of root categories, there is another frequent retainer of objects:
the <code>Environment</code> type. An <code>Environment</code> in Hermes is a simple array that is
used to store captured variables of a closure. In this example you can see that
the variable <code>x</code> is captured:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#FFFFFF;background:#242526"><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">makeCallback</span><span class="token punctuation" style="color:#657b83">(</span><span class="token parameter">x</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token plain"></span></div><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain">  </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">(</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#fc929e">=&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span></div><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain"></span><span class="token punctuation" style="color:#657b83">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The closure returned from <code>makeCallback</code> will capture <code>x</code>, and Hermes implements
this by placing <code>x</code> into an <code>Environment</code> pointed to by the closure.
Environments can be shared if multiple closures capture the same variable:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#FFFFFF;background:#242526"><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">makeManyCallbacks</span><span class="token punctuation" style="color:#657b83">(</span><span class="token parameter">x</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token plain"></span></div><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain">  </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">[</span><span class="token punctuation" style="color:#657b83">(</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#fc929e">=&gt;</span><span class="token plain"> x </span><span class="token operator" style="color:#fc929e">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">{</span><span class="token plain">foo</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token punctuation" style="color:#657b83">}</span><span class="token punctuation" style="color:#657b83">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">(</span><span class="token punctuation" style="color:#657b83">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#fc929e">=&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:#657b83">.</span><span class="token property-access">foo</span><span class="token punctuation" style="color:#657b83">]</span><span class="token punctuation" style="color:#657b83">;</span><span class="token plain"></span></div><div class="token-line" style="color:#FFFFFF;background:#242526"><span class="token plain"></span><span class="token punctuation" style="color:#657b83">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>In this case, both closures will capture the same environment pointing to <code>x</code>,
so the second closure will see updates made by the first closure.
Taking a snapshot of some objects created by calling <code>makeManyCallbacks</code> shows
the following:</p><p><img alt="Object captured by environment" src="/assets/images/object_captured_by_environment-4e6450bd226af5dba63ac61964f794ce.png"></p><p>The <code>[1] in Array</code> shows this was the second closure stored in the array.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="comparing-snapshots"></a>Comparing Snapshots<a class="hash-link" href="#comparing-snapshots" title="Direct link to heading">#</a></h3><p>If you have two heap snapshots from the same execution you can compare them to
each other and see which objects were allocated or destroyed between those
points in time.</p><p>First, load two snapshots into your Chrome workspace. Make sure they are from
the same process. Two snapshots from two separate runs of your app will not be
comparable, and the output might not make sense.</p><p>Then, click on the &quot;Summary&quot; dropdown box at the top and change it to
&quot;Comparison&quot;. If you don&#x27;t see the &quot;Comparison&quot; option that means you don&#x27;t have
two snapshots loaded into Chrome yet. The following video shows how to do this:</p><video muted="" loop="" controls="" height="auto" width="100%" alt="Heap Snapshot Comparison Video"><source src="https://assets.hermesengine.dev/chrome_save_heap_snapshot.mp4" type="video/mp4">Your browser does not support the video/mp4 encoding.</video><p>Once you&#x27;re in a comparison view, you can see what objects were created since
the last snapshot represented by a <code>+</code> icon, and what objects were destroyed
represented by a <code>-</code> icon. The columns are as follows:</p><ul><li><code># New</code>: Number of new objects created of a particular type</li><li><code># Deleted</code>: Number of objects deleted (garbage collected)</li><li><code># Delta</code>: New - Deleted. Positive means more were created than deleted.</li><li><code>Alloc. Size</code>: Size of all newly created objects of that type added together</li><li><code>Freed Size</code>: Size of all deleted objects of that type added together</li><li><code>Size Delta</code>: Alloc. Size - Freed Size. Positive means more bytes were created
than deleted.</li></ul><p>Typically sorting by <code>Size Delta</code> is the most useful for hunting down memory
regressions. A large positive value means a lot of extra bytes were allocated
for that type of object.</p><p>Expanding the type category will show for each object ID, whether it was new
or deleted, and the size it was.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="statistics-view"></a>Statistics View<a class="hash-link" href="#statistics-view" title="Direct link to heading">#</a></h3><p>From the same dropdown menu for selecting &quot;Summary&quot; or &quot;Comparison&quot;, you can
also select &quot;Statistics&quot;, which shows a pie chart of various memory categories.
This view only accounts for a few limited categories of memory, and doesn&#x27;t have
any way to drill down into the category to see more, so this view is of limited
use.</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="heap-timelines"></a>Heap Timelines<a class="hash-link" href="#heap-timelines" title="Direct link to heading">#</a></h1><p>TODO: Fill out this section.</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sampling-heap-profiler"></a>Sampling Heap Profiler<a class="hash-link" href="#sampling-heap-profiler" title="Direct link to heading">#</a></h1><p>TODO: Fill out this section.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/hermes/blob/HEAD/website/../doc/MemoryProfilers.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-03-16T18:10:17.000Z" class="lastUpdatedDate_1WI_">3/16/2021</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/intl"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Internationalization APIs</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/design"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Design Overview Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#taking-a-heap-snapshot-with-the-chrome-devtools" class="table-of-contents__link">Taking a heap snapshot with the Chrome DevTools</a></li><li><a href="#taking-a-heap-snapshot-from-c" class="table-of-contents__link">Taking a heap snapshot from C++</a></li><li><a href="#taking-a-heap-snapshot-from-javascript-with-the-hermes-cli" class="table-of-contents__link">Taking a heap snapshot from JavaScript with the Hermes CLI</a></li><li><a href="#loading-a-heap-snapshot-from-disk" class="table-of-contents__link">Loading a heap snapshot from disk</a></li><li><a href="#using-the-chrome-devtools-heap-snapshot-explorer" class="table-of-contents__link">Using the Chrome DevTools Heap Snapshot Explorer</a><ul><li><a href="#sorting" class="table-of-contents__link">Sorting</a></li><li><a href="#type-names" class="table-of-contents__link">Type names</a></li><li><a href="#retainers" class="table-of-contents__link">Retainers</a></li><li><a href="#comparing-snapshots" class="table-of-contents__link">Comparing Snapshots</a></li><li><a href="#statistics-view" class="table-of-contents__link">Statistics View</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/language-features">Language Features</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/building-and-running">Building and Running</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/emscripten">Building with Emscripten</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Integrations</h4><ul class="footer__items"><li class="footer__item"><a href="https://reactnative.dev/docs/hermes" target="_blank" rel="noopener noreferrer" class="footer__link-item">Using with React Native</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/react-native-integration">Using a custom build with React Native</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/HermesEngine" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://github.com/facebook/hermes" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookies</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_MyFc"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2022 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.aa2d953b.js"></script>
<script src="/assets/js/main.fc6ba424.js"></script>
</body>
</html>